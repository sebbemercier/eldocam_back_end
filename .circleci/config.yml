version: 2.1

# Configuration pour CircleCI Cloud
# NÃ©cessite les contextes :
# - github-creds : DOCKER_LOGIN, DOCKER_PASSWORD
# - nomad-creds : NOMAD_ADDR, NOMAD_TOKEN

jobs:
  build-and-push:
    docker:
      - image: cimg/base:stable
    environment:
      IMAGE_NAME: sebbemercier/eldocam-backend
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Login to GitHub Container Registry
          command: echo "$DOCKER_PASSWORD" | docker login ghcr.io -u "$DOCKER_LOGIN" --password-stdin
      - run:
          name: Build Docker image
          command: |
            export IMAGE_TAG="<< pipeline.number >>-${CIRCLE_SHA1:0:7}"
            docker build -t ghcr.io/$IMAGE_NAME:$IMAGE_TAG -t ghcr.io/$IMAGE_NAME:latest .
      - run:
          name: Push Docker image
          command: |
            export IMAGE_TAG="<< pipeline.number >>-${CIRCLE_SHA1:0:7}"
            docker push ghcr.io/$IMAGE_NAME:$IMAGE_TAG
            docker push ghcr.io/$IMAGE_NAME:latest

  deploy:
    docker:
      - image: hashicorp/nomad:latest
    environment:
      NOMAD_ADDR: https://nomad.eldocam.com
      NOMAD_SKIP_VERIFY: "1"
    steps:
      - checkout
      - run:
          name: Deploy to Nomad
          command: |
            export IMAGE_TAG="<< pipeline.number >>-${CIRCLE_SHA1:0:7}"
            nomad job validate -var image_tag=${IMAGE_TAG} nomad/eldocam-backend.nomad.hcl
            nomad job run -var image_tag=${IMAGE_TAG} nomad/eldocam-backend.nomad.hcl

workflows:
  version: 2
  build-deploy:
    jobs:
      - build-and-push:
          context:
            - github-creds
      - deploy:
          requires:
            - build-and-push
          context:
            - nomad-creds
          filters:
            branches:
              only: main
